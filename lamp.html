<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control ESP via MQTT</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">
    <div class="container mx-auto p-6 bg-white shadow-lg rounded-xl max-w-xl text-center">
        <h1 class="text-2xl font-bold text-green-600 mb-4">Control ESP via MQTT</h1>

        <!-- Status ESP -->
        <div id="espStatus" class="mb-6 p-4 bg-gray-100 rounded-md text-sm text-gray-700">
            Status ESP: <span class="font-bold text-red-500">Terputus</span>
        </div>

        <!-- Kontrol Servo -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Kontrol Servo</h2>
            <input type="number" id="servoPosition" min="0" max="180" placeholder="Masukkan posisi (0-180)"
                class="w-full p-2 border border-gray-300 rounded-md mb-2" />
            <button onclick="sendServoPosition()" 
                class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">
                Set Posisi Servo
            </button>
        </div>

        <!-- Kontrol Lampu -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Kontrol Lampu</h2>
            <div class="flex justify-between">
                <button onclick="controlLamp('ON')" 
                    class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 mr-2">
                    ON
                </button>
                <button onclick="controlLamp('OFF')" 
                    class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 ml-2">
                    OFF
                </button>
            </div>
        </div>

        <!-- Voice Control -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Voice Control</h2>
            <button onclick="startVoiceControl()" 
                class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                ðŸŽ¤ Mulai Voice Control
            </button>
            <p id="voiceStatus" class="text-gray-500 mt-2">Klik tombol di atas untuk memulai kontrol suara.</p>
        </div>

        <!-- Data Suhu dan Kelembaban -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Data Sensor</h2>
            <div class="p-4 bg-gray-100 rounded-md">
                <p>Suhu: <span id="suhu" class="font-bold">--</span> Â°C</p>
                <p>Kelembaban: <span id="kelembaban" class="font-bold">--</span> %</p>
            </div>
        </div>
    </div>

    <script>
        const options = {
            connectTimeout: 4000,
            clientId: 'mqttx_1aba0144',
            username: 'vesuf-iot',
            password: 'vJZW5PbJXWRUpY7t',
            keepalive: 60,
            clean: true,
        };

        const client = mqtt.connect('wss://vesuf-iot.cloud.shiftr.io', options);

        client.on('connect', () => {
            console.log('Terhubung ke broker MQTT');
            document.getElementById('espStatus').innerHTML =
                'Status ESP: <span class="font-bold text-green-500">Terhubung</span>';
            client.subscribe('vesuf-iot/#');
        });

        client.on('error', (err) => {
            console.error('Kesalahan MQTT:', err);
            document.getElementById('espStatus').innerHTML =
                'Status ESP: <span class="font-bold text-red-500">Terputus</span>';
        });

        client.on('message', (topic, message) => {
            const payload = message.toString();
            console.log('Pesan:', topic, payload);

            if (topic === 'vesuf-iot/suhu') {
                document.getElementById('suhu').innerText = payload;
            } else if (topic === 'vesuf-iot/kelembaban') {
                document.getElementById('kelembaban').innerText = payload;
            }
        });

        function sendServoPosition() {
            const position = document.getElementById('servoPosition').value;
            if (position >= 0 && position <= 180) {
                client.publish('vesuf-iot/servo', position, { qos: 1 }, (err) => {
                    if (err) {
                        console.error('Kesalahan Publish:', err);
                    } else {
                        alert(`Posisi Servo diatur ke: ${position}`);
                    }
                });
            } else {
                alert('Masukkan nilai antara 0 dan 180.');
            }
        }

        function controlLamp(state) {
            client.publish('vesuf-iot/lampu', state, { qos: 1 }, (err) => {
                if (err) {
                    console.error('Kesalahan Publish:', err);
                } else {
                    alert(`Lampu ${state === 'ON' ? 'Dinyalakan' : 'Dimatikan'}`);
                }
            });
        }

        function startVoiceControl() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'id-ID'; // Bahasa Indonesia
            recognition.start();

            document.getElementById('voiceStatus').innerText = 'Mendengarkan... Silakan bicara.';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                document.getElementById('voiceStatus').innerText = `Anda berkata: "${transcript}"`;

                const lampOnCommands = ['nyalakan lampu', 'hidupkan lampu', 'lampu nyala'];
                const lampOffCommands = ['matikan lampu', 'lampu mati'];

                if (lampOnCommands.some(command => transcript.includes(command))) {
                    controlLamp('ON');
                } else if (lampOffCommands.some(command => transcript.includes(command))) {
                    controlLamp('OFF');
                } else {
                    alert('Perintah tidak dikenali. Coba "nyalakan lampu" atau "matikan lampu".');
                }
            };

            recognition.onerror = (event) => {
                console.error('Kesalahan Voice Recognition:', event.error);
                document.getElementById('voiceStatus').innerText = 'Terjadi kesalahan. Coba lagi.';
            };
        }
    </script>
</body>
</html>
