<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control ESP via MQTT</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start p-6">

    <!-- Grid untuk dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
        
        <!-- Box untuk status ESP -->
        <div class="p-6 bg-white shadow-lg rounded-xl col-span-1 md:col-span-2 lg:col-span-1">
            <h2 class="text-xl font-semibold mb-4 text-green-600">Status ESP</h2>
            <div id="espStatus" class="p-4 bg-gray-100 rounded-md text-sm text-gray-700">
                Status ESP: <span class="font-bold text-red-500">Terputus</span>
            </div>
        </div>

        <!-- Box untuk data suhu dan kelembaban -->
        <div class="p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Data Sensor</h2>
            <div class="p-4 bg-gray-100 rounded-md">
                <p>Suhu: <span id="suhu" class="font-bold">--</span> Â°C</p>
                <p>Kelembaban: <span id="kelembaban" class="font-bold">--</span> %</p>
            </div>
        </div>

        <!-- Box untuk kontrol servo -->
        <div class="p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Kontrol Servo</h2>
            <input type="number" id="servoPosition" min="0" max="180" placeholder="Masukkan posisi (0-180)"
                class="w-full p-2 border border-gray-300 rounded-md mb-2" />
            <button onclick="sendServoPosition()" 
                class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">
                Set Posisi Servo
            </button>
        </div>

        <!-- Box untuk kontrol lampu -->
        <div class="p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Kontrol Lampu</h2>
            <div class="flex justify-between">
                <button onclick="controlLamp('ON')" 
                    class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 mr-2">
                    ON
                </button>
                <button onclick="controlLamp('OFF')" 
                    class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 ml-2">
                    OFF
                </button>
            </div>
        </div>

        <!-- Box untuk kontrol suara -->
        <div class="p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Voice Control Lampu</h2>
            <button onclick="startVoiceControl()" 
                class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">
                ðŸŽ¤ Mulai Voice Control
            </button>
            <p id="voiceStatus" class="text-gray-500 mt-2">Klik tombol di atas untuk memulai kontrol suara.</p>
        </div>

    </div>

    <script>
        const options = {
            connectTimeout: 4000,
            clientId: 'mqttx_1aba0144',
            username: 'vesuf-iot',
            password: 'vJZW5PbJXWRUpY7t',
            keepalive: 60,
            clean: true,
        };

        const client = mqtt.connect('wss://vesuf-iot.cloud.shiftr.io', options);

        // Connection event
        client.on('connect', () => {
            console.log('Terhubung ke broker MQTT');
            document.getElementById('espStatus').innerHTML =
                'Status ESP: <span class="font-bold text-green-500">Terhubung</span>';
            client.subscribe('vesuf-iot/#');
        });

        // Disconnection event
        client.on('close', () => {
            console.log('Terputus dari broker MQTT');
            document.getElementById('espStatus').innerHTML =
                'Status ESP: <span class="font-bold text-red-500">Terputus</span>';
        });

        client.on('message', (topic, message) => {
            const payload = message.toString();
            console.log('Pesan:', topic, payload);

            if (topic === 'vesuf-iot/suhu') {
                document.getElementById('suhu').innerText = payload;
            } else if (topic === 'vesuf-iot/kelembaban') {
                document.getElementById('kelembaban').innerText = payload;
            }
        });

        function sendServoPosition() {
            const position = document.getElementById('servoPosition').value;
            if (position >= 0 && position <= 180) {
                client.publish('vesuf-iot/servo', position, { qos: 1 }, (err) => {
                    if (err) {
                        alert('Kesalahan saat mengatur posisi servo.');
                        console.error('Kesalahan Publish:', err);
                    }
                });
            } else {
                alert('Masukkan nilai antara 0 dan 180.');
            }
        }

        function controlLamp(state) {
            client.publish('vesuf-iot/lampu', state, { qos: 1 }, (err) => {
                if (err) {
                    alert('Kesalahan saat mengontrol lampu.');
                    console.error('Kesalahan Publish:', err);
                } else {
                    if (state === 'ON') {
                        speakResponse('Lampu nyala.');
                    } else if (state === 'OFF') {
                        speakResponse('Lampu mati.');
                    }
                }
            });
        }

        function speakResponse(text) {
            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'id-ID'; 
            speech.volume = 1; 
            speech.rate = 1; 
            speech.pitch = 1;

            document.body.addEventListener('click', () => {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.speak(speech);
                } else {
                    alert('Speech Synthesis tidak didukung di perangkat ini.');
                }
            }, { once: true });
        }

        function startVoiceControl() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert('Voice recognition tidak didukung pada perangkat ini.');
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'id-ID';

            document.body.addEventListener('click', () => {
                recognition.start();
                document.getElementById('voiceStatus').innerText = 'Mendengarkan... Silakan bicara.';
            }, { once: true });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                document.getElementById('voiceStatus').innerText = `Anda berkata: "${transcript}"`;

                const lampOnCommands = ['nyalakan lampu', 'hidupkan lampu', 'lampu nyala'];
                const lampOffCommands = ['matikan lampu', 'lampu mati'];

                if (lampOnCommands.some(command => transcript.includes(command))) {
                    controlLamp('ON');
                } else if (lampOffCommands.some(command => transcript.includes(command))) {
                    controlLamp('OFF');
                } else {
                    alert('Perintah tidak dikenali. Coba "nyalakan lampu" atau "matikan lampu".');
                }
            };

            recognition.onerror = (event) => {
                console.error('Kesalahan Voice Recognition:', event.error);
                document.getElementById('voiceStatus').innerText = 'Terjadi kesalahan. Coba lagi.';
            };
        }
    </script>
</body>
</html>
